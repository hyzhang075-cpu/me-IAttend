# IAttend 签到App - 后端API文档



### 项目结构
```
app/src/main/java/com/example/iattend/
├── backend/                    # 后端服务层（前端同学使用这个）
│   ├── AuthService.java        # 认证服务类（核心API接口）
│   └── utils/
│       └── LogUtils.java       # 日志工具类
├── data/                       # 数据层
│   ├── remote/                 # 远程数据源
│   │   ├── SupabaseClient.java # Supabase API客户端
│   │   ├── config/             # 配置类
│   │   │   └── SupabaseConfig.java
│   │   └── model/              # 数据模型
│   │       ├── UserProfile.java
│   │       ├── AuthResponse.java
│   │       ├── SignUpRequest.java
│   │       └── LoginRequest.java
│   └── repository/             # 数据仓库
│       └── AuthRepositoryImpl.java
└── domain/                     # 业务领域层
    ├── model/                  # 业务模型
    │   ├── User.java
    │   └── AuthResult.java
```


```

## 核心API接口

### AuthService类
**位置**: `com.example.iattend.backend.AuthService`

这是前端同学主要使用的API服务类，提供了所有认证相关的功能。

#### 1. 用户注册

**方法签名**:
```java
public CompletableFuture<AuthResult> signUp(String email, String password, String name)
```

**参数说明**:
- `email`: 用户邮箱（必须有效邮箱格式）
- `password`: 用户密码（至少6位，建议包含字母和数字）
- `name`: 用户姓名

**返回值**:
- `CompletableFuture<AuthResult>`: 异步返回注册结果

**使用示例**:
```java
AuthService authService = new AuthService();

authService.signUp("user@example.com", "password123", "张三")
    .thenAccept(result -> {
        if (result.isSuccess()) {
            User user = result.getUser();
            String token = result.getToken();

            Log.d("API", "注册成功 - 用户ID: " + user.getId());
            Log.d("API", "用户姓名: " + user.getName());
            Log.d("API", "Token: " + token);

            // 保存用户信息和Token，跳转到主界面
            saveUserInfo(user, token);
            navigateToMain();
        } else {
            String error = result.getMessage();
            Log.e("API", "注册失败: " + error);

            // 显示错误信息给用户
            showErrorToUser(error);
        }
    })
    .exceptionally(throwable -> {
        Log.e("API", "注册异常", throwable);
        return null;
    });
```

**可能返回的错误**:
- "该邮箱已被注册"
- "邮箱格式不正确"
- "密码长度不足"
- "网络连接失败，请检查网络设置"

---

#### 2. 用户登录

**方法签名**:
```java
public CompletableFuture<AuthResult> signIn(String email, String password)
```

**参数说明**:
- `email`: 用户邮箱
- `password`: 用户密码

**返回值**:
- `CompletableFuture<AuthResult>`: 异步返回登录结果

**使用示例**:
```java
AuthService authService = new AuthService();

authService.signIn("user@example.com", "password123")
    .thenAccept(result -> {
        if (result.isSuccess()) {
            User user = result.getUser();
            String token = result.getToken();

            Log.d("API", "登录成功 - 用户ID: " + user.getId());
            Log.d("API", "邮箱验证状态: " + user.isEmailVerified());

            // 保存登录状态
            saveLoginState(user, token);
            navigateToMain();
        } else {
            String error = result.getMessage();
            Log.e("API", "登录失败: " + error);

            // 显示错误信息
            showError(error);
        }
    });
```

**可能返回的错误**:
- "邮箱或密码错误"
- "邮箱尚未验证"
- "网络连接失败，请检查网络设置"

---

#### 3. 获取当前用户信息

**方法签名**:
```java
public CompletableFuture<User> getCurrentUser()
```

**参数说明**: 无

**返回值**:
- `CompletableFuture<User>`: 异步返回用户信息，如果未登录返回null

**使用示例**:
```java
AuthService authService = new AuthService();

authService.getCurrentUser()
    .thenAccept(user -> {
        if (user != null) {
            Log.d("API", "当前用户: " + user.getName());
            Log.d("API", "班级: " + user.getUserClass());
            Log.d("API", "邮箱: " + user.getEmail());

            // 用户已登录，显示用户信息
            showUserInfo(user);
        } else {
            Log.d("API", "用户未登录");

            // 用户未登录，跳转到登录界面
            navigateToLogin();
        }
    });
```

---

#### 4. 更新用户信息

**方法签名**:
```java
public CompletableFuture<AuthResult> updateUser(User user)
```

**参数说明**:
- `user`: 要更新的用户信息对象

**返回值**:
- `CompletableFuture<AuthResult>`: 异步返回更新结果

**使用示例**:
```java
AuthService authService = new AuthService();

// 创建用户对象并设置要更新的信息
User user = new User();
user.setId("当前用户ID"); // 必须设置用户ID
user.setName("新姓名");
user.setUserClass("新班级");
user.setAvatarUrl("头像URL");

authService.updateUser(user)
    .thenAccept(result -> {
        if (result.isSuccess()) {
            User updatedUser = result.getUser();
            Log.d("API", "用户信息更新成功");

            // 更新UI显示
            refreshUserInfo(updatedUser);
        } else {
            String error = result.getMessage();
            Log.e("API", "更新失败: " + error);

            // 显示错误信息
            showError(error);
        }
    });
```

**注意**: 调用此方法前必须确保用户已登录，且用户ID必须正确设置。

---

#### 5. 用户登出

**方法签名**:
```java
public CompletableFuture<Void> signOut()
```

**参数说明**: 无

**返回值**:
- `CompletableFuture<Void>`: 异步返回登出结果

**使用示例**:
```java
AuthService authService = new AuthService();

authService.signOut()
    .thenAccept(result -> {
        Log.d("API", "登出成功");

        // 清除本地保存的用户信息和Token
        clearLocalData();

        // 跳转到登录界面
        navigateToLogin();
    })
    .exceptionally(throwable -> {
        Log.e("API", "登出异常", throwable);
        return null;
    });
```

---

#### 6. 检查用户登录状态

**方法签名**:
```java
public boolean isUserLoggedIn()
```

**参数说明**: 无

**返回值**:
- `boolean`: true表示用户已登录，false表示未登录

**使用示例**:
```java
AuthService authService = new AuthService();

if (authService.isUserLoggedIn()) {
    // 用户已登录，显示主界面
    showMainInterface();
} else {
    // 用户未登录，显示登录界面
    showLoginInterface();
}
```

## 数据模型

### User类
**位置**: `com.example.iattend.domain.model.User`

```java
public class User {
    private String id;          // 用户唯一标识
    private String name;        // 用户姓名
    private String email;       // 用户邮箱
    private String userClass;   // 用户班级
    private String avatarUrl;   // 头像URL
    private boolean isEmailVerified; // 邮箱是否已验证

    // Getter和Setter方法...
}
```

### AuthResult类
**位置**: `com.example.iattend.domain.model.AuthResult`

```java
public class AuthResult {
    private boolean success;    // 操作是否成功
    private String message;     // 操作结果消息
    private User user;          // 用户信息（成功时）
    private String token;       // 认证Token（成功时）

    // Getter和Setter方法...
}
```

## 最佳实践

### 1. 异步调用处理
所有API调用都是异步的，使用CompletableFuture。建议在UI线程中处理结果：

```java
// 在Activity或Fragment中
authService.signIn(email, password)
    .thenAccept(result -> {
        // 这里会在主线程执行
        if (result.isSuccess()) {
            // 更新UI
        }
    });
```

### 2. 错误处理
始终检查返回的AuthResult是否成功，并处理错误情况：

```java
authService.signUp(email, password, name)
    .thenAccept(result -> {
        if (!result.isSuccess()) {
            // 根据错误类型进行不同处理
            String error = result.getMessage();
            if (error.contains("邮箱已被注册")) {
                // 跳转到登录界面
                showLoginDialog();
            } else {
                // 显示错误信息
                showErrorToast(error);
            }
        }
    });
```

### 3. Token管理
登录成功后获得的Token应妥善保存，用于后续的API调用：

```java
// 保存Token到SharedPreferences
SharedPreferences prefs = getSharedPreferences("auth", MODE_PRIVATE);
prefs.edit()
    .putString("token", result.getToken())
    .putString("user_id", result.getUser().getId())
    .apply();
```

### 4. 网络状态检查
在调用API前，建议先检查网络连接状态：

```java
if (!isNetworkAvailable()) {
    showError("请检查网络连接");
    return;
}

authService.signIn(email, password);
```

## 环境配置

### 开发环境
- DEBUG日志默认开启，可在LogUtils中控制
- 使用开发环境的Supabase配置

### 生产环境
- 建议关闭DEBUG日志：`LogUtils.setDebugEnabled(false)`
- 使用生产环境的Supabase配置
- 注意保护API密钥安全
